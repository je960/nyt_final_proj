---
title: "nyt_final_proj"
author: "Jerrica Li"
date: "4/3/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include = FALSE}
library(tidyverse)
library(broom)
library(dplyr)
library(infer)
library(ggplot2)
library(ggthemes)
library(lubridate)
library(dplyr)
library(tidycensus)
library(janitor)
```

```{r reading data}
state_data <- read.csv("covid-19-data/us-states.csv") 
county_data <- read.csv('covid-19-data/us-counties.csv')
#yes <- state_data %>% 
        #filter(date == latest_date)
#us.map.county <- readOGR(dsn= 'cb_2018_us_county_500k', layer = "cb_2018_us_county_500k", stringsAsFactors = FALSE)

# Remove Mariana Islands (69), Micronesia (64), Marshall Islands (68), Palau (70), Minor Islands (74)
#us.map.county <- us.map.county[!us.map.county$STATEFP %in% c("69","64", "68", "70", "74"),]

# Make sure other outling islands are removed.
#us.map.county <- us.map.county[!us.map.county$STATEFP %in% c("81", "84", "86", "87", "89", "71", "76","95", "79"),]
```

```{r cleaning data}
#clean state data so dates are class "date

state_data <- 
  state_data %>% 
  mutate(new_date = as_date(date),
         GEOID = fips) %>% 
  select(-date, -fips) %>% 
  mutate(date = new_date)

#clean state data so dates are class "date
county_data <- 
  county_data %>% 
  mutate(new_date = as_date(date),
         geoid = as.character(fips)) %>% 
  select(-date, -fips) %>% 
  rename(date = new_date)

glimpse(county_data)
```

```{r leaflet}

latest_date <- county_data %>% 
  filter(state == "Washington") %>% 
  arrange(desc(date)) %>% 
  slice(1) %>% 
  pull(date)

washington <- county_data %>% 
  filter(state == "Washington", 
         date == latest_date)
  
leafmap <- merge(us.map.county, county_data, by= 'GEOID', duplicateGeoms = TRUE)


popup_dat <- paste0("<strong>State: </strong>",
                    leafmap$state,
                    "<br><strong> Number of cases: </strong>",
                    leafmap$cases)
pal <- colorNumeric("RdYlGn", NULL, n = 10)


  leaflet(data = leafmap) %>% 
      addTiles() %>%
      addPolygons(fillColor = ~pal(cases),
                  fillOpacity = 0.8,
                  color = "#BDBDC3",
                  weight = 1,
                  popup = popup_dat) %>%
      addLegend("bottomright", pal = pal, values = ~cases,
                title = "Number of cases",
                opacity = 1 )

  #Keep in mind when creating a color palette
#transform values keeping in mind your range is from 0-100000
#log might be good to change colors or manually define shades 
#try hotspot states like new jersey or ny 
  #try selecting palates based on number of cases 
  #addProviderTiles(provider = "CartoDB.Positron")
#More things to try:
#death rates, death rates plotted by county / state and to see is it rural places? urban cities? the south? 
#by state, see population size over case rate, 

```

```{r}


county_n <- county_data %>% 
  rename(county_fips = GEOID) %>% 
  mutate(county_fips = as.character(county_fips)) %>% 
  filter(state == "Washington", date == latest_date)

household_data <- full_join(county_n, counties, by = "county_fips") 


countydata %>% 
  left_join(counties, by = "county_fips") %>% 
  filter(state_name =="California") %>% 
  ggplot(mapping = aes(long, lat, group = group, fill = horate)) +
  geom_polygon(color = "#ffffff", size = .25) +
  scale_fill_gradientn(labels = scales::percent,
                       guide = guide_colorbar(title.position = "top")) +
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  theme(legend.title = element_text(),
        legend.key.width = unit(.5, "in")) +
  labs(fill = "Homeownership rate") +
  theme_urbn_map()

ggplot() + 
  geom_polygon(data = urbnmapr::states, mapping = aes(x = long, y = lat, group = group),
		           fill = "gray", color = "white") +
  coord_map(projection = "albers", lat0 = 39, lat1 = 45)
```

```{r}
counties_sf <- get_urbn_map(map = "counties", sf = TRUE)

counties_yes <- counties_sf %>% 
  filter(state_name == "Washington")

countyiess <- (full_join(counties_yes, county_n, by = "county_fips"))



states_sf <- get_urbn_map(map = "states", sf = TRUE)

state_data <- left_join(states_sf, statedata, by = "state_name")

ggplot() +
  geom_sf(data = state_data, mapping = aes(fill = medhhincome))
ggplot() +
  geom_sf(data = countyiess, mapping = aes(fill = cases))
```



```{r tab three change in cases over time}

wash$change <- NA
for(i in 2:nrow(wash)){
  wash$change[i] <- wash$cases[i] - wash$cases[i - 1]
}

plot(wash$new_date, log(wash$change), type = 'l')

```



```{r plotting, include = FALSE}

ggplot(wash, aes(x = new_date, y = cases)) +
  geom_line() +
  geom_point() + 
  theme_minimal() +

  theme(axis.text.x = element_text(angle = 70, hjust = 1), 
        panel.grid.major = element_blank()) + 
  labs(title = "Confirmed Corona Cases by State (Washington)", 
       x = "date", 
       y = "confirmed cases") +
  scale_x_date(date_breaks = "2 days", date_labels = "%b %d") +
  #geom_area from this github https://gist.github.com/jtrive84/b1a5d191358883dea1d511d8c78929b6#file-ggplot_auc-r-L9
  
  geom_area(mapping=aes(x=new_date), fill="#9898fb", alpha=.5) 
  
  #I was looking at this https://stackoverflow.com/questions/47667994/ggplot-x-axis-labels-with-all-x-axis-values for the longest time before I realized that I can change this by using scale_x_date()

```

```{r}
counties_map <- get_acs(geography = "county",
                  variables = c(pop = "B00001_001"), 
                  year = 2018,
                  geometry = TRUE) %>% 
  clean_names() %>% 
   select(geoid, 
          name, 
          "pop" = estimate,
          geometry) %>% 
  separate(col = name, c("county", "state"), sep = ", ")

options(tigris_use_cache = TRUE)

county_latest <- county_data %>% 
  filter(date == latest_date) %>% 
  mutate(county = as.character(county))
county_latest %>% filter(state == "California")
counties_map %>% filter(state == "California")

#2,820 rows
glimpse(county_latest)

#3,220 rows
glimpse(counties_map)

#2,508 rows
glimpse(merged)

county_map_data <- counties_map %>% 
  left_join(county_latest, by = "geoid") %>% 
    select(geoid, 
         "county" = county.x,
         "state" = state.y,
         date, 
         cases, 
         deaths, 
         geometry)
glimpse(merge_test)

merge_test %>% filter(state == "California")

merged <- merge(county_latest, counties_map, by = "geoid") %>% 
  select(geoid, 
         "county" = county.x,
         "state" = state.y,
         date, 
         cases, 
         deaths, 
         geometry)
merged %>% filter(state == "California")
```

```{r}
        merge_test %>% filter(state == "California")
            ggplot(map = aes(fill = cases, geometry = geometry)) +
            geom_sf(data = merge_test) + 
            scale_fill_viridis_c(option = "plasma") + 
            labs(caption = "Sources: The New York Times and the American Community Survey 2014-2018", 
                 fill = "Total Cases") + 
            theme_void()

```

```{r ggsave, include = FALSE}
ggsave(path = "nyt_corona", filename = "washington.png")
```

```{r saving data}
saveRDS(county_data, file = "nyt_corona/county_data")
saveRDS(state_data, file = "nyt_corona/state_data")
saveRDS(yes, file = "nyt_corona/yes")
saveRDS(merge, file = "FinalProjectV1.0/county_data.rds")
```

```{r}
#ist of online resources I looked at 
# # https://stackoverflow.com/questions/1330989/rotating-and-spacing-axis-labels-in-ggplot2
```

